<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.2">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>index – Rømer Chain</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-07c16812f08c4a1591d6ec4fc46327fa.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-bebea915e746d702e8312f8ca858bea9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&amp;display=swap" rel="stylesheet">


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Rømer Chain</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../pitch/index.html"> 
<span class="menu-text">Deck</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tokenomics" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tokenomics</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tokenomics">    
        <li>
    <a class="dropdown-item" href="../../../economics/index.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../economics/model.html">
 <span class="dropdown-text">Economic Model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../economics/distribution.html">
 <span class="dropdown-text">Token Distribution</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../economics/market.html">
 <span class="dropdown-text">Market Dynamics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../economics/validators.html">
 <span class="dropdown-text">Validator Economics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-technical-design" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Technical Design</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-technical-design">    
        <li>
    <a class="dropdown-item" href="../../../technical/index.html">
 <span class="dropdown-text">Architecture Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../technical/pop.html">
 <span class="dropdown-text">Proof of Physics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../technical/network.html">
 <span class="dropdown-text">Network Design</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../technical/devnet.html">
 <span class="dropdown-text">Development Roadmap</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../technical/validators.html">
 <span class="dropdown-text">Validator Requirements</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#order-flow-wars-from-wall-street-to-blockchain" id="toc-order-flow-wars-from-wall-street-to-blockchain" class="nav-link active" data-scroll-target="#order-flow-wars-from-wall-street-to-blockchain">Order Flow Wars: From Wall Street to Blockchain</a>
  <ul class="collapse">
  <li><a href="#the-power-of-seeing-whats-next" id="toc-the-power-of-seeing-whats-next" class="nav-link" data-scroll-target="#the-power-of-seeing-whats-next">The Power of Seeing What’s Next</a></li>
  <li><a href="#from-wall-street-to-crypto-the-evolution-of-speed-trading" id="toc-from-wall-street-to-crypto-the-evolution-of-speed-trading" class="nav-link" data-scroll-target="#from-wall-street-to-crypto-the-evolution-of-speed-trading">From Wall Street to Crypto: The Evolution of Speed Trading</a></li>
  <li><a href="#why-order-flow-matters-a-super-bowl-betting-analogy" id="toc-why-order-flow-matters-a-super-bowl-betting-analogy" class="nav-link" data-scroll-target="#why-order-flow-matters-a-super-bowl-betting-analogy">Why Order Flow Matters: A Super Bowl Betting Analogy</a></li>
  <li><a href="#different-approaches-to-the-order-box" id="toc-different-approaches-to-the-order-box" class="nav-link" data-scroll-target="#different-approaches-to-the-order-box">Different Approaches to the Order Box</a>
  <ul class="collapse">
  <li><a href="#ethereums-open-auction-system" id="toc-ethereums-open-auction-system" class="nav-link" data-scroll-target="#ethereums-open-auction-system">Ethereum’s Open Auction System</a></li>
  <li><a href="#solanas-private-line" id="toc-solanas-private-line" class="nav-link" data-scroll-target="#solanas-private-line">Solana’s Private Line</a></li>
  </ul></li>
  <li><a href="#rømers-new-approach" id="toc-rømers-new-approach" class="nav-link" data-scroll-target="#rømers-new-approach">Rømer’s New Approach</a>
  <ul class="collapse">
  <li><a href="#pay-first-model" id="toc-pay-first-model" class="nav-link" data-scroll-target="#pay-first-model">Pay-First Model</a></li>
  <li><a href="#geographic-balance" id="toc-geographic-balance" class="nav-link" data-scroll-target="#geographic-balance">Geographic Balance</a></li>
  <li><a href="#rotating-service-windows" id="toc-rotating-service-windows" class="nav-link" data-scroll-target="#rotating-service-windows">Rotating Service Windows</a></li>
  </ul></li>
  <li><a href="#the-future-of-market-structure" id="toc-the-future-of-market-structure" class="nav-link" data-scroll-target="#the-future-of-market-structure">The Future of Market Structure</a></li>
  <li><a href="#looking-forward" id="toc-looking-forward" class="nav-link" data-scroll-target="#looking-forward">Looking Forward</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="order-flow-wars-from-wall-street-to-blockchain" class="level1">
<h1>Order Flow Wars: From Wall Street to Blockchain</h1>
<p>Imagine you’re at a busy auction house. Before an item goes up for bid, some buyers get to peek at what’s coming up next, while others have to wait. Those with the early peek have an obvious advantage - they can prepare their bids and strategy before anyone else. This is essentially what happens in financial markets through something called “order flow” - the stream of incoming trades that people want to make.</p>
<section id="the-power-of-seeing-whats-next" class="level2">
<h2 class="anchored" data-anchor-id="the-power-of-seeing-whats-next">The Power of Seeing What’s Next</h2>
<p>Let’s start with a simple example from traditional stock trading. When you click “buy” on your trading app to purchase some Apple shares, your order doesn’t go directly to the stock exchange. Instead, it typically goes through several intermediaries, each of whom gets to see your intention to buy before it becomes public knowledge.</p>
<p>This advance knowledge is incredibly valuable. If someone knows you’re about to buy 1,000 shares of Apple at the market price, they could quickly buy shares themselves and sell them to you at a slightly higher price. This practice, known as front-running in traditional markets, has evolved into a sophisticated industry in the world of cryptocurrency.</p>
</section>
<section id="from-wall-street-to-crypto-the-evolution-of-speed-trading" class="level2">
<h2 class="anchored" data-anchor-id="from-wall-street-to-crypto-the-evolution-of-speed-trading">From Wall Street to Crypto: The Evolution of Speed Trading</h2>
<p>On Wall Street, high-frequency trading (HFT) firms spend millions of dollars to place their computers as close as possible to stock exchanges. They even lay specialized cables to gain microsecond advantages in trading speed. When a pension fund wants to buy a large amount of shares, these HFT firms can spot the order coming and react before it hits the exchange.</p>
<p>In cryptocurrency markets, this race for speed has taken on new forms. Instead of building faster cables, traders compete to have their transactions included in the next block of a blockchain. This competition is what we call MEV (Maximal Extractable Value), and it’s become a multi-billion dollar industry.</p>
</section>
<section id="why-order-flow-matters-a-super-bowl-betting-analogy" class="level2">
<h2 class="anchored" data-anchor-id="why-order-flow-matters-a-super-bowl-betting-analogy">Why Order Flow Matters: A Super Bowl Betting Analogy</h2>
<p>Imagine you’re at a Las Vegas sportsbook during the Super Bowl. Bettors are lining up to place their wagers at betting windows. As the game progresses, the betting odds constantly change based on what’s happening on the field. Now imagine three different scenarios:</p>
<p>First, think about someone who could see all the bets people are about to place before they reach the window. If they notice a large bet coming that might move the odds, they could quickly place their own bet first at better odds. This is exactly how order flow works in financial markets - seeing what trades are coming before they happen is incredibly valuable information.</p>
<p>Second, consider if someone could pay extra to jump to the front of the betting line during crucial moments - like right after a big touchdown when everyone’s rushing to place bets at the current odds. They’d have a huge advantage over other bettors who have to wait in line while the odds change. This is similar to how traders pay higher fees to have their transactions processed first in cryptocurrency markets.</p>
<p>Third, picture if certain bettors had a special VIP betting window that processed their bets faster than the regular windows. While everyone else waits in long lines watching the odds change, these VIP bettors could always get their bets in quickly at the odds they want. This is like having special access to faster blockchain infrastructure.</p>
<p>This is similar to how order flow works in crypto markets. The line of people waiting to place bets is like the “mempool” - where transactions wait to be processed. Different blockchain networks handle this queue of transactions in different ways.</p>
</section>
<section id="different-approaches-to-the-order-box" class="level2">
<h2 class="anchored" data-anchor-id="different-approaches-to-the-order-box">Different Approaches to the Order Box</h2>
<section id="ethereums-open-auction-system" class="level3">
<h3 class="anchored" data-anchor-id="ethereums-open-auction-system">Ethereum’s Open Auction System</h3>
<p>Ethereum treats its order box like a transparent auction house. Everyone can see the incoming orders, and traders can openly bid to have their transactions processed first. While this is transparent, it means that regular users often have to pay extra to have their transactions processed in a timely manner.</p>
</section>
<section id="solanas-private-line" class="level3">
<h3 class="anchored" data-anchor-id="solanas-private-line">Solana’s Private Line</h3>
<p>Solana takes a different approach - like a special VIP line that only certain customers know about. While this prevents some types of front-running, it gives special advantages to those with insider access to the network.</p>
</section>
</section>
<section id="rømers-new-approach" class="level2">
<h2 class="anchored" data-anchor-id="rømers-new-approach">Rømer’s New Approach</h2>
<p>Rømer Chain is trying to create a fairer system through several innovations:</p>
<section id="pay-first-model" class="level3">
<h3 class="anchored" data-anchor-id="pay-first-model">Pay-First Model</h3>
<p>The Move VM takes a fundamentally different approach. Rather than allowing cheap transaction reverts, it requires all computational costs to be paid upfront. Success or failure, the resources consumed by a transaction must be paid for. This shifts the economic model from “try everything and pay for successes” to “carefully validate before attempting.” The result is more efficient network usage and reduced spam opportunities.</p>
</section>
<section id="geographic-balance" class="level3">
<h3 class="anchored" data-anchor-id="geographic-balance">Geographic Balance</h3>
<p>Instead of having one central location where all orders are processed, Rømer spreads out its order processing across many locations. This prevents any one location from having too much control over all the orders.</p>
</section>
<section id="rotating-service-windows" class="level3">
<h3 class="anchored" data-anchor-id="rotating-service-windows">Rotating Service Windows</h3>
<p>Rather than allowing geographic concentration to determine transaction ordering, Rømer’s consensus mechanism incorporates physical location as a core part of its design. This distributes transaction processing across a broader geographic area, reducing the advantages of proximity to any single point of infrastructure.</p>
</section>
</section>
<section id="the-future-of-market-structure" class="level2">
<h2 class="anchored" data-anchor-id="the-future-of-market-structure">The Future of Market Structure</h2>
<p>The goal isn’t to eliminate all MEV - that would be both impossible and, in some cases, undesirable. Rather, Rømer Chain aims to create a market structure where:</p>
<ul>
<li>Value extraction requires actual market intelligence rather than just technical advantages</li>
<li>Infrastructure positioning can’t override market fundamentals</li>
<li>Failed speculation has real costs that must be considered</li>
<li>Information flow follows natural network topology rather than centralized paths</li>
</ul>
<p>This creates an environment where MEV extraction aligns more closely with genuine market making and price discovery, rather than pure technical exploitation. The result is a more efficient market where resources flow toward actual value creation rather than rent-seeking behavior.</p>
</section>
<section id="looking-forward" class="level2">
<h2 class="anchored" data-anchor-id="looking-forward">Looking Forward</h2>
<p>The conversation around MEV often focuses on whether it can be eliminated. This misses the point. The real question is how we can structure markets to channel trading activity toward beneficial forms of value extraction while making harmful forms prohibitively expensive. Through its combination of economic incentives, geographic distribution, and infrastructure rotation, Rømer Chain works to create markets where MEV extraction aligns with, rather than opposes, market efficiency.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("http:\/\/romer\.network");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>